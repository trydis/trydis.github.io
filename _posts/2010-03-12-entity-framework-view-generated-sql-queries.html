---
layout: post
title: Entity Framework – View generated SQL queries
date: 2010-03-12 00:08:18.000000000 +01:00
categories:
- Entity Framework
tags:
- Entity Framework
- extension methods
- sql
status: publish
type: post
published: true
meta:
  delicious: a:3:{s:5:"count";s:1:"0";s:9:"post_tags";s:0:"";s:4:"time";s:10:"1335463046";}
  reddit: a:2:{s:5:"count";i:0;s:4:"time";i:1367998641;}
author:
  login: trydal
  email: trydis@hotmail.com
  display_name: trydal
  first_name: ''
  last_name: ''
---
</p></p>
<p>I’ve created an example that uses the “Orders” and “Order_Details” tables in the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=06616212-0356-46a0-8da2-eebc53a68034&amp;displaylang=en" target="_blank">Northwind database</a>, to show how you can easily view the SQL queries that are being generated by the <a href="http://msdn.microsoft.com/en-us/library/bb399572(VS.100).aspx" target="_blank">Entity Framework</a>. In order to simplify this I’ve created a static class called “ExtensionMethods” which has two extension methods, both named “SqlQuery”. </p>
<h3>The code</h3>
<p>In the first query I’m retrieving the orders that have been shipped&#160; to Norway. In this case it will return the matching orders as IQueryable&lt;Order&gt;, since this table is on the “one” end of the relationship with “Order_Details”. </p>
<p>In the second query I want the order details of order 10248. Since the order details table is on the “many” end of the relationship with “Orders” it will return the order details as EntityCollection&lt;Order_Detail&gt;. </p>
<p>We have to treat these two types differently in order to extract the SQL query generated by the Entity Framework. How this can be done is shown in the 2nd snippet below.</p>
<p></p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:5bc712f5-ede1-4158-b0d5-8e590a018bbf" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#000000;overflow:auto;white-space:nowrap;padding:2px 5px;"><span style="color:#cc7832;">static</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">void</span><span style="color:#ffffff;"> Main()</span><br /> <span style="color:#ffffff;">{</span><br /> <span style="color:#ffffff;">    </span><span style="color:#cc7832;">using</span><span style="color:#ffffff;"> (</span><span style="color:#ffc66d;">NorthwindEntities</span><span style="color:#ffffff;"> db = </span><span style="color:#cc7832;">new</span><span style="color:#ffffff;"> </span><span style="color:#ffc66d;">NorthwindEntities</span><span style="color:#ffffff;">())</span><br /> <span style="color:#ffffff;">    {</span><br /> <span style="color:#ffffff;">        </span><span style="color:#6897bb;">IQueryable</span><span style="color:#ffffff;">&lt;</span><span style="color:#ffc66d;">Order</span><span style="color:#ffffff;">&gt; orders = db.Orders</span><br /> <span style="color:#ffffff;">            .Where(x =&gt; x.ShipCountry == </span><span style="color:#a5c25c;">&quot;Norway&quot;</span><span style="color:#ffffff;">);</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#ffc66d;">Console</span><span style="color:#ffffff;">.WriteLine(</span><span style="color:#a5c25c;">&quot;Generated SQL query: &quot;</span><span style="color:#ffffff;"> +</span><br /> <span style="color:#ffffff;">            </span><span style="color:#ffc66d;">Environment</span><span style="color:#ffffff;">.NewLine +</span><br /> <span style="color:#ffffff;">            orders.SqlQuery() +</span><br /> <span style="color:#ffffff;">            </span><span style="color:#ffc66d;">Environment</span><span style="color:#ffffff;">.NewLine);</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#ffc66d;">EntityCollection</span><span style="color:#ffffff;">&lt;</span><span style="color:#ffc66d;">Order_Detail</span><span style="color:#ffffff;">&gt; orderDetails = db.Orders</span><br /> <span style="color:#ffffff;">            .Where(x =&gt; x.OrderID == </span><span style="color:#6897bb;">10248</span><span style="color:#ffffff;">)</span><br /> <span style="color:#ffffff;">            .First()</span><br /> <span style="color:#ffffff;">            .Order_Details;</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#ffc66d;">Console</span><span style="color:#ffffff;">.WriteLine(</span><span style="color:#a5c25c;">&quot;Generated SQL query: &quot;</span><span style="color:#ffffff;"> +</span><br /> <span style="color:#ffffff;">            </span><span style="color:#ffc66d;">Environment</span><span style="color:#ffffff;">.NewLine +</span><br /> <span style="color:#ffffff;">            orderDetails.SqlQuery());</span><br /> <span style="color:#ffffff;">    }</span><br /> <span style="color:#ffffff;">}</span></div>
</p></div>
</p></div></p></p>
<p>&#160;</p>
<p>And here are the extension methods I’ve created, which return the generated SQL queries for data of IQueryable&lt;T&gt; and EntityCollection&lt;T&gt;, respectively.</p></p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:483decc5-b9a6-4e15-a2d8-f616c65c622e" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#000000;overflow:auto;white-space:nowrap;padding:2px 5px;"><span style="color:#cc7832;">public</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">static</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">class</span><span style="color:#ffffff;"> </span><span style="color:#ffc66d;">ExtensionMethods</span><br /> <span style="color:#ffffff;">{</span><br /> <span style="color:#ffffff;">    </span><span style="color:#cc7832;">public</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">static</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">string</span><span style="color:#ffffff;"> SqlQuery&lt;T&gt;(</span><span style="color:#cc7832;">this</span><span style="color:#ffffff;"> </span><span style="color:#6897bb;">IQueryable</span><span style="color:#ffffff;">&lt;T&gt; source)</span><br /> <span style="color:#ffffff;">    {</span><br /> <span style="color:#ffffff;">        </span><span style="color:#ffc66d;">ObjectQuery</span><span style="color:#ffffff;">&lt;T&gt; objectQuery = source </span><span style="color:#cc7832;">as</span><span style="color:#ffffff;"> </span><span style="color:#ffc66d;">ObjectQuery</span><span style="color:#ffffff;">&lt;T&gt;;</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#cc7832;">if</span><span style="color:#ffffff;"> (objectQuery != </span><span style="color:#cc7832;">null</span><span style="color:#ffffff;">)</span><br /> <span style="color:#ffffff;">            </span><span style="color:#cc7832;">return</span><span style="color:#ffffff;"> objectQuery.ToTraceString();</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#cc7832;">return</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">string</span><span style="color:#ffffff;">.Empty;</span><br /> <span style="color:#ffffff;">    }</span></p>
<p> <span style="color:#ffffff;">    </span><span style="color:#cc7832;">public</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">static</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">string</span><span style="color:#ffffff;"> SqlQuery&lt;T&gt;(</span><span style="color:#cc7832;">this</span><span style="color:#ffffff;"> </span><span style="color:#ffc66d;">EntityCollection</span><span style="color:#ffffff;">&lt;T&gt; source) </span><span style="color:#cc7832;">where</span><span style="color:#ffffff;"> T : </span><span style="color:#cc7832;">class</span><br /> <span style="color:#ffffff;">    {</span><br /> <span style="color:#ffffff;">        </span><span style="color:#ffc66d;">ObjectQuery</span><span style="color:#ffffff;">&lt;T&gt; objectQuery = source.CreateSourceQuery();</span></p>
<p> <span style="color:#ffffff;">        </span><span style="color:#cc7832;">return</span><span style="color:#ffffff;"> objectQuery.ToTraceString();</span><br /> <span style="color:#ffffff;">    }</span><br /> <span style="color:#ffffff;">}</span></div>
</p></div>
</p></div></p>
<p>&#160;</p>
<p>And here’s the output:</p>
<p><a href="../../assets/ef_sql_thumb.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="ef_sql" border="0" alt="ef_sql" src="../../assets/ef_sql_thumb.png" width="385" height="359" /></a> </p>
<p>Enjoy!</p>
